
import time
import threading
import json
import websocket

from config import SYMBOLS, TRADE_AMOUNT_USD, TELEGRAM_TOKEN, TELEGRAM_CHAT_ID, COMMISSION
from telegram_utils import send_telegram_message

entry_prices = {}
trades = {}

def on_message(ws, message):
    try:
        data = json.loads(message)
        if "data" in data and isinstance(data["data"], list):
            update = data["data"][0]
            symbol = update.get("s")
            bid = float(update["b"])
            ask = float(update["a"])
            spread = ask - bid
            gross_profit = spread
            net_profit = gross_profit - COMMISSION

            print(f"[{symbol}] BID: {bid}, ASK: {ask}, SPREAD: {spread:.4f}, Net: {net_profit:.4f}")

            entry_price = entry_prices.get(symbol)

            if entry_price and bid < entry_price * 0.985:
                send_telegram_message(f"üîª [{symbol}] –¶–µ–Ω–∞ —É–ø–∞–ª–∞ > 1.5% ‚Äî —Å–¥–µ–ª–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
                return

            if entry_price and bid < entry_price * 0.993:
                send_telegram_message(f"üõë [{symbol}] –°—Ç–æ–ø-–ª–æ—Å—Å: BID = {bid}")
                entry_prices[symbol] = None
                return

            if net_profit > 0.01:
                entry_prices[symbol] = ask
                trade_time = time.strftime('%H:%M:%S')
                trades.setdefault(symbol, []).append((trade_time, ask))
                send_telegram_message(f"üü¢ [{symbol}] BUY @ {ask:.2f}")
    except Exception as e:
        send_telegram_message(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ [{symbol}]: {e}")

def on_open(ws):
    print("üß© –í–Ω—É—Ç—Ä–∏ on_open")
    args = [f"orderbook.1.{symbol}" for symbol in SYMBOLS]
    ws.send(json.dumps({
        "op": "subscribe",
        "args": args
    }))
    for symbol in SYMBOLS:
        send_telegram_message(f"ü§ñ [{symbol}] –ë–æ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ —Å—Ç–∞–∫–∞–Ω—É –∏ –∑–∞–ø—É—â–µ–Ω.")

def heartbeat():
    while True:
        time.sleep(600)
        print("üíì Heartbeat: –±–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω")
        send_telegram_message("‚úÖ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω")

def summary():
    while True:
        time.sleep(3600)
        print("üìù –°–≤–æ–¥–∫–∞ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è")
        for symbol, symbol_trades in trades.items():
            if symbol_trades:
                msg = f"üìä [{symbol}] –°–≤–æ–¥–∫–∞ –∑–∞ —á–∞—Å:\n"
                for t, p in symbol_trades:
                    msg += f"{t}: BUY @ {p:.2f}\n"
                send_telegram_message(msg)
        trades.clear()

def run_bot():
    print("‚öôÔ∏è run_bot() –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è")
    threading.Thread(target=heartbeat, daemon=True).start()
    threading.Thread(target=summary, daemon=True).start()

    while True:
        try:
            print("üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket...")
            ws = websocket.WebSocketApp(
                "wss://stream.bybit.com/v5/public/spot",
                on_open=on_open,
                on_message=on_message
            )
            print("üü¢ WebSocket —Å–æ–∑–¥–∞–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º run_forever()")
            ws.run_forever()
        except Exception as e:
            send_telegram_message(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")
            time.sleep(10)

if __name__ == "__main__":
    print("üöÄ main.py —Å—Ç–∞—Ä—Ç—É–µ—Ç")
    run_bot()
